# Mapping A Driver in Realtime on the Web

This demo covers how to visualize a driver moving on a map in realtime in a browser. This demo is written in JS and uses the Ably realtime JavaScript SDK, Mapbox-gl and the Mapbox Turf plugin. It is built in Node with Express.

## server.js

We're running an Express.js server - `server.js`.

```js
const express = require("express");
const Ably = require('ably/promises');
const client = new Ably.Realtime(process.env.ABLY_API_KEY);
```

First, it includes both `express` and the `ably/promises` SDK using require.
Next, we create a new instance of the *Ably.Realtime* `client` passing `process.env.ABLY_API_KEY` to it's constructor.

Make sure you have created a `.env` file in the root of the web directory that looks something like this:

```bash
ABLY_API_KEY=yourably:apikeyhere
MAPBOX_API_KEY=yourmapboxapikey
```

Next, we create our express instance and map the default route to serve our `views/index.html` file.

```js
const app = express();
app.get("/", async (request, response) => {
  response.sendFile(__dirname + '/views/index.html');
});
```

**We're now going to create an additional route to create Ably Token Request objects.**

```js
app.get("/api/createTokenRequest", async (request, response) => {
  const tokenRequestData = await client.auth.createTokenRequest({ clientId: 'ably-client-side-api-calls-demo' });
  response.send(tokenRequestData);
});
```

Using the `client` we created earlier, we can now create a token request. This API is served on the URL `/api/createTokenRequest`.
There's nothing special about that URL, we just need to make sure our client can access it. The `clientId` should be meaningful and distinct.

The `TokenRequest` that is generated by this SDK call happens without calling the Ably servers, and allows the client side SDK to authenticate
because the `TokenRequest` is signed with your API key on the server before it is sent to Ably.

The `permissions` applied to the temporary token Ably returns to your client are **inherited** from your API key, and configured in your Ably dashboard.

Then finally we start the Express application:

```js
app.listen(port, () => console.log(`Example app listening at http://localhost:${port}`))
```

## index.html

The markup for the app in `views/index.html`. In the `<head>` we include the Ably SDK from the Ably CDN and the Mapbox libraries we'll require for the app along with the JS we'll be writing to create the app.

We'll also link the CSS to style the app and the Mapbox CSS to style the map.

## script.js

This is where we'll connect to our Ably channel and get data to the Mapbox map.

First we set up a Mapbox map on the page and set its initial style, center lat-long and zoom level.

Then we instance the ably realtime library, create a channel and connect to that channel:

```js
  const ably = new Ably.Realtime.Promise({ authUrl: '/api/createTokenRequest' });
  const channelId = `agent002.delivery223.locations`;  
  const channel = ably.channels.get(channelId);

  await channel.attach();
```

Here we configure our Ably SDK to 
* Use the `Promise` client (which supports async/await)
* Pass a configuration object with an `authUrl`.

When the client is created, it'll call our Express.js APIs `createTokenRequest` function, and round-trip to Ably to get a short-lived authentication token for subsequent API calls, renewing its token as required automatically.

